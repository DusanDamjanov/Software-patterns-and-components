<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        {% load static %}
        <link rel='stylesheet' href="{% static 'style.css' %}"/>
        <title> {{title}} </title>
    </head>
    <body>
        <div class="page">
            <div class="header">
                <label for="data-type-selector">Select type of data to parse: </label>
                <select id="data-type-selector" style="width: 160px;">
                    {% for loader in loaders %}
                        <option value="{{ loader.name}}">{{ loader.name }}</option>
                    {% endfor %}
                </select>
                <label for="data-content-selector" >Select which file to parse: </label>
                <select id="data-content-selector" style="width: 160px;">
                    {% for file in data %}
                        <option value="{{ file }}">{{ file }}</option>
                    {% endfor %}
                </select>
                <label for="visualizator-type-selector">Select type of visualization: </label>
                <select id="visualizator-type-selector" style="width: 160px;">
                    {% for visualizer in visualizers %}
                    <!-- izmenila sam u visualizer.identifier umesto samo viusalizer-->
                        <option value="{{ visualizer.name }}">{{ visualizer.name }}</option>
                    {% endfor %}
                </select>
                <button id="start-parsing" type="button">Start parse</button>
                <button id="reset-button" type="button">Reset</button>


            </div>
            <div class="graphs">
                <div class="left">
                    {% block treeView %}
                    {% endblock %}
                </div>
                <div id="right">
                    {% block graphView %}
                    {% endblock %}
                    <!-- UBACEN ID ZARAD RENDER PROBE!-->
                    <div id="graph-container"></div>
                </div>
            </div>
        </div>
<!-- Include jQuery library -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>

    $("#start-parsing").on("click", function () {
        var visualizer= $("#visualizator-type-selector").val();
        var loader = $("#data-type-selector").val();
        var file = $("#data-content-selector").val();
        var csrf_token = "{{ csrf_token }}";  // Add CSRF token if needed

        console.log("Visualizer: ", visualizer);
        console.log("Loader: ", loader);
        console.log("File: ", file);


        $.ajax({
            url: "{% url 'simple_visualization_data_processing' %}",
            method: "POST",
            data: {
                visualizer: visualizer,  // Use the correct ID for visualizer
                loader: loader,
                file: file,
                csrfmiddlewaretoken: csrf_token

            },
            success: function (response) {
                // Handle successful response, e.g., render the visualization
                renderVisualization(response.visualization_data);
            },
            error: function (xhr, status, error) {
                // Handle error
                console.error(error);
            }
        });
    });

function renderVisualization(visualizationData) {
    d3.select("#graph-container").selectAll("*").remove();
    const svg = d3.select("#graph-container")
        .append("svg")
        .attr("width", "100%")
        .attr("height", "100%")
        .append("g");


    // Define zoom behavior
    const zoom = d3.zoom()
        .scaleExtent([0.1, 10])
        .on("zoom", function () {
            svg.attr("transform", d3.event.transform);
        });

    // Apply zoom behavior to SVG
    svg.call(zoom);

    // Add mouseover event for nodes
    const tooltip = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

    let nodeIndex = 0; // Initialize index variable

    const link = svg.append("g")
        .selectAll("line")
        .data(visualizationData.edges)
        .enter().append("line")
        .style("stroke", "#004445")
        .style("stroke-width", "2px");

    const node = svg.append("g")
        .selectAll("g")
        .data(visualizationData.nodes)
        .enter().append("g")
        .on("mouseover", function (event, d) {
            tooltip.transition()
                .duration(200)
                .style("opacity", .9);
            tooltip.html("Hovered node: " + d.id)
                .style("left", (event.pageX) + "px")
                .style("top", (event.pageY - 28) + "px");
        })
        .on("mouseout", function (d) {
            tooltip.transition()
                .duration(500)
                .style("opacity", 0);
        })
        .call(d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended))
        .on("click", function (event, d) { // Show message on node click
            alert("You clicked on node: " + d.id)});


    node.append("circle")
        .attr("r", 8)
        .style("fill", "#fde9df")
        .style("stroke", "#ffd6a4");

    node.append("text") // Append text for node ID
    .attr("dy", -12) // Position text above the circle
    .attr("text-anchor", "middle") // Center text horizontally
    .text(() => "ID: " + ++nodeIndex); // Set text content to "ID: " followed by the incremented index

    const simulation = d3.forceSimulation(visualizationData.nodes)
        .force("link", d3.forceLink(visualizationData.edges).id(d => d.id))
        .force("charge", d3.forceManyBody())
        .force("center", d3.forceCenter(400, 300))
        .on("tick", ticked);

    function ticked() {
        link
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);

        node.attr("transform", d => `translate(${d.x},${d.y})`);
    }

    function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }

    function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
    }

    function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
    }

    // Add reset button
    const resetButton = d3.select("#reset-button");
    resetButton.on("click", function () {
        svg.selectAll("*").remove();
    });

        // Add zoom in button
    const zoomInButton = svg.append("g")
        .attr("class", "zoom-button")
        .attr("transform", "translate(" + (svg.attr("width") - 40) + "," + (svg.attr("height") - 40) + ")")
        .on("click", function () {
            svg.transition().call(zoom.scaleBy, 1.5);
        });

    zoomInButton.append("circle")
        .attr("r", 12)
        .attr("fill", "#419698")
        .style("cursor", "pointer");

    zoomInButton.append("text")
        .attr("text-anchor", "middle")
        .attr("dy", 4)
        .style("font-size", "20px")
        .text("+");

    // Add zoom out button
    const zoomOutButton = svg.append("g")
        .attr("class", "zoom-button")
        .attr("transform", "translate(" + (svg.attr("width") - 40) + "," + (svg.attr("height") - 80) + ")")
        .on("click", function () {
            svg.transition().call(zoom.scaleBy, 0.75);
        });

    zoomOutButton.append("circle")
        .attr("r", 12)
        .attr("fill", "#419698")
        .style("cursor", "pointer");

    zoomOutButton.append("text")
        .attr("text-anchor", "middle")
        .attr("dy", 4)
        .style("font-size", "20px")
        .text("-");
}





</script>
    </body>
</html>